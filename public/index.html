// server.js
const express = require("express");
const app = express();
const http = require("http").createServer(app);
const io = require("socket.io")(http);
const path = require("path");

const PORT = process.env.PORT || 3000;

app.use(express.static("public"));

// Pre-assigned roles
const secureRoles = {
  "VIoNW": { role: "OWNER", password: "GreenTiger#428" },
  "ABC123": { role: "MOD", password: "ModPass123" }
};

const users = new Map();
const bannedUsers = new Set();

function buildUserList() {
  return Array.from(users.values());
}

io.on("connection", (socket) => {
  users.set(socket.id, { id: socket.id, name: "Unknown", role: "User", pfp: null });

  socket.on("set-name", ({ name, userId, password }) => {
    if (bannedUsers.has(userId)) {
      socket.emit("system", { text: "You are banned.", time: Date.now() });
      return socket.disconnect(true);
    }

    let role = "User";
    if (userId && secureRoles[userId]) {
      const { role: targetRole, password: requiredPassword } = secureRoles[userId];
      if (!requiredPassword || password === requiredPassword) role = targetRole;
    }

    users.set(socket.id, {
      id: userId || socket.id,
      name: String(name).trim().slice(0, 30) || "Unknown",
      role,
      pfp: null
    });

    io.emit("userlist", buildUserList());
    io.emit("system", { text: `[${role}] ${users.get(socket.id).name} joined.`, time: Date.now() });
  });

  socket.on("set-pfp", (imgData) => {
    const user = users.get(socket.id);
    if (user) {
      user.pfp = imgData;
      io.emit("userlist", buildUserList());
    }
  });

  socket.on("chat-message", (msg) => {
    const user = users.get(socket.id);
    if (!user) return;

    const payload = {
      id: user.id,
      name: user.name,
      role: user.role,
      text: typeof msg.text === "string" ? msg.text.slice(0, 2000) : "",
      img: typeof msg.img === "string" ? msg.img : null,
      pfp: user.pfp,
      time: Date.now()
    };
    io.emit("chat-message", payload);
  });

  socket.on("kick-user", (targetId) => {
    const actor = users.get(socket.id);
    if (!actor || (actor.role !== "OWNER" && actor.role !== "MOD")) return;

    const target = [...users.values()].find(u => u.id === targetId);
    if (target) {
      const targetSocket = [...io.sockets.sockets.values()].find(s => users.get(s.id)?.id === targetId);
      if (targetSocket) targetSocket.disconnect(true);
    }
  });

  socket.on("ban-user", (targetId) => {
    const actor = users.get(socket.id);
    if (!actor || (actor.role !== "OWNER" && actor.role !== "MOD")) return;

    bannedUsers.add(targetId);
    const targetSocket = [...io.sockets.sockets.values()].find(s => users.get(s.id)?.id === targetId);
    if (targetSocket) targetSocket.disconnect(true);
  });

  socket.on("disconnect", () => {
    const name = users.get(socket.id)?.name || "Unknown";
    users.delete(socket.id);
    io.emit("userlist", buildUserList());
    io.emit("system", { text: `${name} left.`, time: Date.now() });
  });
});

http.listen(PORT, () => console.log(`âœ… Chat server running on http://localhost:${PORT}`));
